---
title: "Dirty Data Project - Task 4 Halloween Candy Data"
output:
  html_document:
    toc: yes
    toc_float: true
    toc_depth: '2'
    highlight: tango
    df_print: paged
---
```{r}

```

## Introduction



## Assumptions



## Cleaning


## Load libraries and import data
```{r}
library(tidyverse)
library(here)

candy <- read_csv(here("clean_data/clean_candy_data.csv"))
```



## Question 1

**What is the total number of candy ratings given across the three years?**

```{r}
candy %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~sum(!is.na(.x)))) %>% 
  rowSums()

# Code to check answer
# sum(is.na(candy[6:123]))
```
There were 772,352 candy ratings given across the three years. 

To check this number the number of NAs was determined and subtracted from the total number of entries. 
118 candy columns *  9349 rows = 1,103,182 entries
Missing values (NAs) = 330830
1,103,183 - 330,830 = 772,352 which is our original answer!


## Question 2

**What was the average age of people who are going out trick or treating?**

```{r}
candy %>% 
  filter(going_out == "Yes") %>% 
  summarise(avg_age_trick_or_treaters = round(mean(age, na.rm = TRUE)))
```
The average age of trick or treaters is 35 which seems rather high. Perhaps this is parents who are going out with their children. 

## Question 3

**What was the average age of people who are not going out trick or treating?**

```{r}
candy %>% 
  filter(going_out == "No") %>% 
  summarise(avg_age_trick_or_treaters = round(mean(age, na.rm = TRUE)))
```
The average age of people not going out trick or treating was 39. I can't think of anything interesting to say about this answer, feel like this might be wrong or I'm missing something. 


## Question 4

**For each of joy, despair and meh, which candy bar received the most of these ratings**

Assumption -  this means which candy received highest number of joy ratings, the highest number of meh ratings etc. 

```{r}
candy %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~sum(.x == "JOY")))


candy %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~distinct(.x))
  )
)      
   




candy %>% 
  select(abstained_from_m_and_m_ing) %>% 
  group_by(abstained_from_m_and_m_ing) %>% 
  summarise(count = n())


candy %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(.col = "JOY")
  )
  )


candy %>% 
  filter(across(
    .cols = 6:123,
    ))
  
results <-  sapply(X = candy[6:123], FUN = table)  

results4 <- as.data.frame(results)


results2 <- data.frame(matrix(unlist(results), nrow=118, byrow=FALSE),stringsAsFactors=FALSE)


results3 <-  as_tibble(results, .rows = 118, .name_repair = c("DESPAIR", "JOY", "MEH"))



results2
```

## Question 5

**How many people rated Starburst as despair?**

```{r}
candy %>% 
  filter(starburst == "DESPAIR") %>% 
  summarise(starburst_as_despair = n())
```
Personally I am not a fan of starburst (or Opal Fruits as they were when I was a kid) so I feel this number should be higher!


## Question 6

**What was the most popular candy bar by the -1, 0, 1 rating system for each gender in the dataset?**

```{r}
# These JOY, DESPAIR, MEH strings won't be identified in the non-candy columns (e.g. if "meh" was part of a country name) as they are capitalised and the other columns are lower or sentence case. 

candy <- candy %>% 
  mutate_all(~str_replace(., "JOY", "1")) %>% 
  mutate_all(~str_replace(., "DESPAIR", "-1")) %>% 
  mutate_all(~str_replace(., "MEH", "0")) %>% 
  mutate(across((6:123), as.numeric))

# remove this once cleaning script has been rerun and analysis data reloaded
candy$gender <- str_to_lower(candy$gender)


# The function below filters by gender, then sums each of the columns
# The results are converted into a dataframe, transposed and filtered to reveal the top scoring candy. 

high_score_by_gender <- function(dataset, sex){
# sex options are: female, male, i'd rather not say, other
  gender_results <- dataset %>% 
  filter(gender == sex) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
 
  gender_results <- as.data.frame(t(gender_results)) %>% 
  rownames_to_column() %>% 
  cbind(sex) %>% 
  rename(score = V1, sweet = rowname, gender = sex) %>% 
  relocate(gender, .before = sweet) %>% 
  filter(score == max(score))
  
  gender_results
}

# Creating empty dataframe 
most_popular_candy_by_gender <- data.frame(
  gender = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) %>% 
# Adding results from running the function with each gender to dataframe
    rbind(high_score_by_gender(candy, "female"), high_score_by_gender(candy, "male"), 
        high_score_by_gender(candy, "i'd rather not say"), high_score_by_gender(candy, "other"))

most_popular_candy_by_gender
           
# should i care that it asks for the most popular candy bar and there are lots of things in the dataset that aren't candy bars?
```

## Question 7

**What was the most popular candy bar in each year?**

```{r}
high_score_by_year <- function(dataset, yr){
# year options are: 2015, 2016 and 2017
  year_results <- dataset %>% 
  filter(year == yr) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  year_results <- as.data.frame(t(year_results)) %>% 
  rownames_to_column() %>% 
  cbind(yr) %>% 
  rename(score = V1, sweet = rowname, year = yr) %>% 
  relocate(year, .before = sweet) %>% 
  filter(score == max(score))
  
  year_results
}

# Creating empty dataframe 
most_popular_candy_by_year <- data.frame(
  year = as.numeric(),
  sweets = as.character(),
  score = as.numeric()
  ) %>% 
# Adding results from running the function with each year to dataframe
    rbind(high_score_by_year(candy, 2015), high_score_by_year(candy, 2016), 
        high_score_by_year(candy, 2017))

most_popular_candy_by_year
```


## Question 8

**What was the most popular candy bar by this rating for people in US, Canada, UK, and all other countries**

```{r}
high_score_by_country <- function(dataset, cntry){
  country_results <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  cbind(cntry) %>% 
  rename(score = V1, sweet = rowname, country = cntry) %>% 
  relocate(country, .before = sweet) %>% 
  filter(score == max(score))
  
  country_results
}

# Creating empty dataframe 
most_popular_candy_by_country <- data.frame(
  country = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) 

# Adding results from running the function with countries to dataframe
most_popular_candy_by_country <- most_popular_candy_by_country %>% 
rbind(high_score_by_country(candy, "usa"), high_score_by_country(candy, "canada"), 
        high_score_by_country(candy, "uk"))

most_popular_candy_by_country



```

```{r}
# Creating a dataframe of countries other than US, UK and Canada
all_other_countries_df <- candy %>% 
  filter(!country %in% c("usa", "canada", "uk")) %>% 
  filter(!is.na(country))

all_other_countries_vec <- all_other_countries_df$country


high_score_by_multiple_countries <- function(dataset, cntry){
  country_results <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  rename(score = V1, sweet = rowname) %>% 
  filter(score == max(score))
  
  country_results
}

high_score_by_multiple_countries(candy, all_other_countries_vec)






```



```{r}
high_score_by_NA_country <- function(dataset){
  country_results <- dataset %>% 
  filter(is.na(country)) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  rename(score = V1, sweet = rowname) %>% 
  filter(score == max(score))
  
  country_results
}

high_score_by_NA_country(candy)
```

```{r}
top_3_by_country <- function(dataset, cntry){
  top3_country <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  top3_country <- as.data.frame(t(top3_country)) %>% 
  rownames_to_column() %>% 
  cbind(cntry) %>% 
  rename(score = V1, sweet = rowname, country = cntry) %>% 
  relocate(country, .before = sweet) %>% 
  arrange(desc(score)) %>% 
  head(3)
    
    #filter(score == slice_max(score, 3))
  
  top3_country
}

# Creating empty dataframe 
top3_candies_by_country <- data.frame(
  country = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) 

# Adding results from running the function with countries to dataframe
top3_candies_by_country <- top3_candies_by_country %>% 
rbind(top_3_by_country(candy, "usa"), top_3_by_country(candy, "canada"), 
        top_3_by_country(candy, "uk"))

top3_candies_by_country


top_3_by_country(candy, "uk")

# Would be nice to add a rank but I'm done
```

