---
title: "Dirty Data Project - Task 4 Halloween Candy Data"
output:
  html_document:
    toc: yes
    toc_float: true
    toc_depth: '2'
    highlight: tango
    df_print: paged
---


I realise now I could have very easily answered this question by using pivot_longer but I love my function and it took me ages so I've left it in. It also displays all the results together in a nice dataframe. 

```{r}
# These JOY, DESPAIR, MEH strings won't be identified in the non-candy columns (e.g. if "meh" was part of a country name) as they are capitalised and the other columns are lower or sentence case. 

candy <- candy %>% 
  mutate_all(~str_replace(., "JOY", "1")) %>% 
  mutate_all(~str_replace(., "DESPAIR", "-1")) %>% 
  mutate_all(~str_replace(., "MEH", "0")) %>% 
  mutate(across((6:123), as.numeric))

# remove this once cleaning script has been rerun and analysis data reloaded
candy$gender <- str_to_lower(candy$gender)


# The function below filters by gender, then sums each of the columns
# The results are converted into a dataframe, transposed and filtered to reveal the top scoring candy. 

high_score_by_gender <- function(dataset, sex){
# sex options are: female, male, i'd rather not say, other
  gender_results <- dataset %>% 
  filter(gender == sex) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
 
  gender_results <- as.data.frame(t(gender_results)) %>% 
  rownames_to_column() %>% 
  cbind(sex) %>% 
  rename(score = V1, sweet = rowname, gender = sex) %>% 
  relocate(gender, .before = sweet) %>% 
  filter(score == max(score))
  
  gender_results
}

# Creating empty dataframe 
most_popular_candy_by_gender <- data.frame(
  gender = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) %>% 
# Adding results from running the function with each gender to dataframe
    rbind(high_score_by_gender(candy, "female"), high_score_by_gender(candy, "male"), 
        high_score_by_gender(candy, "i'd rather not say"), high_score_by_gender(candy, "other"))

most_popular_candy_by_gender
           
```

As for the results, nothing interesting here, full sized candy bars popular across all genders. 

## Question 7

**What was the most popular candy bar in each year?**

I adapted my beautiful function to work with year, again pivot_longer would have provided a much quicker and easier answer. 

```{r}
high_score_by_year <- function(dataset, yr){
# year options are: 2015, 2016 and 2017
  year_results <- dataset %>% 
  filter(year == yr) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  year_results <- as.data.frame(t(year_results)) %>% 
  rownames_to_column() %>% 
  cbind(yr) %>% 
  rename(score = V1, sweet = rowname, year = yr) %>% 
  relocate(year, .before = sweet) %>% 
  filter(score == max(score))
  
  year_results
}

# Creating empty dataframe 
most_popular_candy_by_year <- data.frame(
  year = as.numeric(),
  sweets = as.character(),
  score = as.numeric()
  ) %>% 
# Adding results from running the function with each year to dataframe
    rbind(high_score_by_year(candy, 2015), high_score_by_year(candy, 2016), 
        high_score_by_year(candy, 2017))

most_popular_candy_by_year
```

Full sized candy bars proving popular across the years. 


## Question 8

**What was the most popular candy bar by this rating for people in US, Canada, UK, and all other countries**

```{r}
high_score_by_country <- function(dataset, cntry){
  country_results <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  cbind(cntry) %>% 
  rename(score = V1, sweet = rowname, country = cntry) %>% 
  relocate(country, .before = sweet) %>% 
  filter(score == max(score))
  
  country_results
}

# Creating empty dataframe 
most_popular_candy_by_country <- data.frame(
  country = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) 

# Adding results from running the function with countries to dataframe
most_popular_candy_by_country <- most_popular_candy_by_country %>% 
rbind(high_score_by_country(candy, "usa"), high_score_by_country(candy, "canada"), 
        high_score_by_country(candy, "uk"))

most_popular_candy_by_country



```

In the UK cash rules, here cash is rated higher than the full sized candy bar. 

I spent a very, very long time try to get the function to take in a vector of countries as an argument. I added an if else statement at the cbind() line which worked on length of the cntry argument but ran into errors. I understood why I was getting the error but didn't manage to fix it. 

The code for "all other countries" is below. 



```{r}
# Creating a dataframe of countries other than US, UK and Canada
all_other_countries_df <- candy %>% 
  filter(!country %in% c("usa", "canada", "uk")) %>% 
  filter(!is.na(country))
# Extracting countries into a vector
all_other_countries_vec <- all_other_countries_df$country


high_score_by_multiple_countries <- function(dataset, cntry){
  country_results <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  rename(score = V1, sweet = rowname) %>% 
  filter(score == max(score))
  
  country_results
}

high_score_by_multiple_countries(candy, all_other_countries_vec)
```





For completeness I adapted the function slightly to determine the top rated candy for when country is NA. The results were surprising!

```{r}
high_score_by_NA_country <- function(dataset){
  country_results <- dataset %>% 
  filter(is.na(country)) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  country_results <- as.data.frame(t(country_results)) %>% 
  rownames_to_column() %>% 
  rename(score = V1, sweet = rowname) %>% 
  filter(score == max(score))
  
  country_results
}

high_score_by_NA_country(candy)
```


Just kidding - no surprises here. Full sized candy bars are top again. 


## Extra analysis 

**Question 6 What was the most popular candy bar by the -1, 0, 1 rating system for each gender in the dataset?**

This is the code for answering question 6 by using pivot_longer. 

```{r}








```





**Investigating top 3 candy's by country**

```{r}
top_3_by_country <- function(dataset, cntry){
  top3_country <- dataset %>% 
  filter(country == cntry) %>% 
  summarise(across(
    .cols = 6:123,
    .fns = ~ sum(., na.rm = TRUE)
    )
  )
# Tried to keep the pipe going but couldn't get the as.data.frame(t()) function to work so left the above and below code separate 
  top3_country <- as.data.frame(t(top3_country)) %>% 
  rownames_to_column() %>% 
  cbind(cntry) %>% 
  rename(score = V1, sweet = rowname, country = cntry) %>% 
  relocate(country, .before = sweet) %>% 
  arrange(desc(score)) %>% 
  head(3)
    
    #filter(score == slice_max(score, 3))
  
  top3_country
}

# Creating empty dataframe 
top3_candies_by_country <- data.frame(
  country = as.character(),
  sweets = as.character(),
  score = as.numeric()
  ) 

# Adding results from running the function with countries to dataframe
top3_candies_by_country <- top3_candies_by_country %>% 
rbind(top_3_by_country(candy, "usa"), top_3_by_country(candy, "canada"), 
        top_3_by_country(candy, "uk"))

top3_candies_by_country

# Would be nice to add a rank but I'm done
```

